---
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

interface Props {
	title?: string;
	description?: string;
	lang?: "zh" | "en";
	ogType?: "website" | "article";
}

const { lang = "zh" } = Astro.props;

const defaults = {
	zh: {
		title: "宜启智控 - 智能物联网自动化控制器",
		description:
			"无需编程的智能物联网自动化万能控制器，手机APP轻松配置，支持95%市场传感器",
		keywords: "宜启智控,物联网,自动化控制器,智能控制,MQTT,IoT,PLC替代",
	},
	en: {
		title: "IOTAutoMate - Smart IoT Automation Controller",
		description:
			"No-code smart IoT automation universal controller, easy mobile app configuration, supports 95% of market sensors",
		keywords:
			"IOTAutoMate,IoT,Automation Controller,Smart Control,MQTT,PLC Alternative",
	},
}[lang] || {
	title: "宜启智控 - 智能物联网自动化控制器",
	description:
		"无需编程的智能物联网自动化万能控制器，手机APP轻松配置，支持95%市场传感器",
	keywords: "宜启智控,物联网,自动化控制器,智能控制,MQTT,IoT,PLC替代",
};

const {
	title = defaults.title,
	description = defaults.description,
	ogType = "website",
} = Astro.props;

const siteUrl = "https://ylznc.com";
const canonicalURL = new URL(Astro.url.pathname, siteUrl);

// 自动计算另一个语言的链接
const alternateLang = lang === "zh" ? "en" : "zh";
const alternatePathname = Astro.url.pathname.replace(
	`/${lang}/`,
	`/${alternateLang}/`,
);
const alternateURL = new URL(alternatePathname, siteUrl);
---

<!doctype html>
<html lang={lang}>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="description" content={description} />
		<meta name="keywords" content={defaults.keywords} />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>

		<!-- Canonical and Hreflang -->
		<link rel="canonical" href={canonicalURL} />
		<link
			rel="alternate"
			hreflang="zh"
			href={new URL(
				Astro.url.pathname.replace(`/${lang}/`, "/zh/"),
				siteUrl,
			)}
		/>
		<link
			rel="alternate"
			hreflang="en"
			href={new URL(
				Astro.url.pathname.replace(`/${lang}/`, "/en/"),
				siteUrl,
			)}
		/>
		<link
			rel="alternate"
			hreflang="x-default"
			href={new URL(
				Astro.url.pathname.replace(`/${lang}/`, "/zh/"),
				siteUrl,
			)}
		/>

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content={ogType} />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={new URL("/favicon.svg", siteUrl)} />

		<!-- Twitter -->
		<meta property="twitter:card" content="summary_large_image" />
		<meta property="twitter:url" content={canonicalURL} />
		<meta property="twitter:title" content={title} />
		<meta property="twitter:description" content={description} />
		<meta
			property="twitter:image"
			content={new URL("/favicon.svg", siteUrl)}
		/>

		<!-- JSON-LD Structured Data -->
		<script
			type="application/ld+json"
			is:inline
			set:html={JSON.stringify({
				"@context": "https://schema.org",
				"@type": "Organization",
				name: lang === "zh" ? "宜启智控" : "IOTAutoMate",
				url: siteUrl,
				logo: new URL("/favicon.svg", siteUrl),
				description: description,
				sameAs: ["https://ylznc.com"],
			})}
		/>

		<!-- Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&display=swap"
			rel="stylesheet"
		/>

		<!-- Alpine.js -->
		<script
			defer
			src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
		></script>
		<script>
			if (typeof window !== "undefined") {
				const STORAGE_KEY = "tutorialSidebarScroll";
				window.addEventListener("load", () => {
					const isTutorialPage = /^\/(zh|en)\/tutorials/.test(
						window.location.pathname,
					);
					if (!isTutorialPage) return;

					const sidebar = document.querySelector(".sidebar");
					if (!(sidebar instanceof HTMLElement)) return;

					// 1. 恢复之前的滚动位置（针对刷新或手动浏览）
					const saved = window.sessionStorage.getItem(STORAGE_KEY);
					if (saved !== null) {
						const value = parseInt(saved, 10);
						if (!Number.isNaN(value)) {
							sidebar.scrollTop = value;
						}
					}

					// 2. 自动定位到当前选中的小节（针对页面切换）
					// 如果是新页面跳转，且没有保存的滚动位置或滚动位置为0，则尝试定位
					const activeLink = sidebar.querySelector(
						".section-link.active",
					);
					if (activeLink instanceof HTMLElement) {
						// 只有当没有保存的非零位置时，才强制滚动到活跃项
						// 或者您可以选择总是确保活跃项在视图中
						activeLink.scrollIntoView({
							block: "nearest",
							behavior: "auto",
						});
					}

					// 3. 记录滚动位置
					sidebar.addEventListener("scroll", () => {
						window.sessionStorage.setItem(
							STORAGE_KEY,
							String(sidebar.scrollTop),
						);
					});
				});
			}
		</script>
	</head>
	<body>
		<Header lang={lang} />
		<main>
			<slot />
		</main>
		<Footer lang={lang} />
	</body>
</html>

<style is:global>
	:root {
		--primary: #0066cc;
		--primary-light: rgba(0, 102, 204, 0.1);
		--primary-dark: #004c99;
		--accent: #ff6b35;
		--accent-light: rgba(255, 107, 53, 0.1);
		--text-dark: #1e293b;
		--text-muted: #64748b;
		--text-light: #94a3b8;
		--bg-light: #f8fafc;
		--bg-white: #ffffff;
		--border-light: rgba(0, 102, 204, 0.1);
	}

	* {
		box-sizing: border-box;
	}

	html,
	body {
		margin: 0;
		padding: 0;
		width: 100%;
		min-height: 100vh;
		font-family: "Noto Sans SC", "Inter", sans-serif;
		color: var(--text-dark);
		background: var(--bg-white);
		line-height: 1.6;
	}

	body {
		display: flex;
		flex-direction: column;
	}

	main {
		flex: 1;
	}

	a {
		color: var(--primary);
		text-decoration: none;
		transition: color 0.2s ease;
	}

	a:hover {
		color: var(--primary-dark);
	}

	img {
		max-width: 100%;
		height: auto;
	}

	/* Smooth scrolling */
	html {
		scroll-behavior: smooth;
	}

	/* Focus styles for accessibility */
	:focus-visible {
		outline: 2px solid var(--primary);
		outline-offset: 2px;
	}

	/* Animation utilities */
	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.animate-fade-in-up {
		animation: fadeInUp 0.6s ease-out forwards;
	}
</style>
