---
// Header component with navigation and language switcher
const { lang = "zh" } = Astro.props;

const navItems = {
    zh: [
        { href: `/${lang}/`, label: "首页" },
        { href: `/${lang}/hardware`, label: "硬件接口" },
        { href: `/${lang}/tutorials`, label: "教程" },
        { href: `/${lang}/mqtt`, label: "MQTT协议" },
        { href: `/${lang}/cases`, label: "应用场景" },
        { href: `/${lang}/compare`, label: "优势对比" },
        { href: `/${lang}/download`, label: "APP下载" },
        { href: `/${lang}/buy`, label: "购买" },
        { href: `/${lang}/about`, label: "关于" },
    ],
    en: [
        { href: `/${lang}/`, label: "Home" },
        { href: `/${lang}/hardware`, label: "Hardware" },
        { href: `/${lang}/tutorials`, label: "Tutorials" },
        { href: `/${lang}/mqtt`, label: "MQTT Protocol" },
        { href: `/${lang}/cases`, label: "Use Cases" },
        { href: `/${lang}/compare`, label: "Comparison" },
        { href: `/${lang}/download`, label: "APP Download" },
        { href: `/${lang}/buy`, label: "Buy" },
        { href: `/${lang}/about`, label: "About" },
    ],
};

const pathname = Astro.url.pathname.replace(/\/$/, "");
const currentNav = navItems[lang as keyof typeof navItems] || navItems.zh;
const switchLang = lang === "zh" ? "en" : "zh";
const switchLabel = lang === "zh" ? "EN" : "中文";
---

<header class="header" x-data="{ mobileMenuOpen: false }">
    <div class="header-container">
        <!-- Logo -->
        <a href={`/${lang}/`} class="logo">
            <img
                src="/images/logos/ylai.svg"
                alt={lang === "zh" ? "宜启智控" : "IOTAutoMate"}
                class="logo-img"
            />
            <div class="logo-info">
                <span class="logo-text">
                    {
                        lang === "zh"
                            ? "源来智能 • 宜启智控"
                            : "YLAI • IOTAutoMate"
                    }
                </span>
                <span class="logo-subtitle">
                    {
                        lang === "zh"
                            ? "让你以最简单便捷的方式实现智能物联网自动化控制"
                            : "The simplest way to achieve smart IoT automation control"
                    }
                </span>
            </div>
        </a>

        <!-- Desktop Navigation with Responsive "More" Dropdown -->
        <nav
            class="nav-desktop"
            x-data="{
                visibleCount: 99,
                open: false,
                itemWidths: [],
                calculateVisible() {
                    const containerWidth = this.$refs.navContainer.offsetWidth;
                    const moreBtnWidth = 70; // Precise estimate for More button

                    let totalWidth = 0;
                    let count = 0;

                    for (let i = 0; i < this.itemWidths.length; i++) {
                        const itemWidth = this.itemWidths[i];
                        // If we are about to overflow, stop and leave room for 'More' button
                        if (totalWidth + itemWidth + moreBtnWidth > containerWidth && i < this.itemWidths.length - 1) {
                            break;
                        }
                        totalWidth += itemWidth;
                        count++;
                    }

                    // Special case: if all items fit, we don't need the More button room
                    let allFitWidth = this.itemWidths.reduce((a, b) => a + b, 0);
                    if (allFitWidth <= containerWidth) {
                        this.visibleCount = this.itemWidths.length;
                    } else {
                        this.visibleCount = count;
                    }
                },
                init() {
                    // Start by showing everything to measure
                    this.visibleCount = 99;
                    this.$nextTick(() => {
                        const items = Array.from(this.$refs.navContainer.querySelectorAll('.nav-link-wrapper'));
                        this.itemWidths = items.map(item => item.offsetWidth + 8); // 8 is gap
                        this.calculateVisible();
                    });
                }
            }"
            @resize.window.debounce.100ms="calculateVisible()"
            x-ref="navContainer"
        >
            {
                currentNav.map((item, index) => {
                    const baseHref = item.href.replace(/\/$/, "");
                    const isHome = baseHref === `/${lang}`;
                    const isActive = isHome
                        ? pathname === baseHref
                        : pathname === baseHref ||
                          pathname.startsWith(baseHref + "/");
                    return (
                        <div
                            class="nav-link-wrapper"
                            x-show={`${index} < visibleCount`}
                        >
                            <a
                                href={item.href}
                                class:list={["nav-link", { active: isActive }]}
                            >
                                {item.label}
                            </a>
                        </div>
                    );
                })
            }

            {/* "More" Dropdown Trigger */}
            <div
                class="more-dropdown-container"
                x-show={`visibleCount < ${currentNav.length}`}
                x-cloak
                @click.away="open = false"
            >
                <button
                    class="nav-link more-trigger"
                    @click="open = !open"
                    :class="{ 'active': open }"
                >
                    <span>{lang === "zh" ? "更多" : "More"}</span>
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                        class="chevron"
                        :class="{ 'rotate-180': open }"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>

                <div
                    class="more-dropdown-menu"
                    x-show="open"
                    x-cloak
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 transform scale-95"
                    x-transition:enter-end="opacity-100 transform scale-100"
                >
                    {
                        currentNav.map((item, index) => {
                            const baseHref = item.href.replace(/\/$/, "");
                            const isHome = baseHref === `/${lang}`;
                            const isActive = isHome
                                ? pathname === baseHref
                                : pathname === baseHref ||
                                  pathname.startsWith(baseHref + "/");
                            return (
                                <a
                                    href={item.href}
                                    class:list={[
                                        "more-dropdown-item",
                                        { active: isActive },
                                    ]}
                                    x-show={`${index} >= visibleCount`}
                                >
                                    {item.label}
                                </a>
                            );
                        })
                    }
                </div>
            </div>
        </nav>

        <!-- Language Switcher & Mobile Menu Button -->
        <div class="header-actions">
            {
                (
                    <a
                        href={`/${switchLang}${Astro.url.pathname.replace(/^\/(zh|en)/, "")}`}
                        class="lang-switch"
                    >
                        {switchLabel}
                    </a>
                )
            }
            <button
                class="mobile-menu-btn"
                @click="mobileMenuOpen = !mobileMenuOpen"
                :aria-expanded="mobileMenuOpen"
            >
                <svg
                    x-show="!mobileMenuOpen"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    class="menu-icon"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
                <svg
                    x-show="mobileMenuOpen"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    class="menu-icon"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="nav-mobile" x-show="mobileMenuOpen" x-transition>
        {
            currentNav.map((item) => {
                const baseHref = item.href.replace(/\/$/, "");
                const isHome = baseHref === `/${lang}`;
                const isActive = isHome
                    ? pathname === baseHref
                    : pathname === baseHref ||
                      pathname.startsWith(baseHref + "/");
                return (
                    <a
                        href={item.href}
                        class:list={["nav-link-mobile", { active: isActive }]}
                    >
                        {item.label}
                    </a>
                );
            })
        }
    </nav>
</header>

<style>
    .header {
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(0, 102, 204, 0.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .header-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 1.5rem;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    @media (min-width: 1024px) {
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        flex: 0 1 auto;
        min-width: 0;
    }

    .logo-img {
        height: 40px;
        width: auto;
        border-radius: 8px;
        flex-shrink: 0;
    }

    .logo-text {
        font-size: 1.25rem;
        font-weight: 700;
        color: #0066cc;
        line-height: 1.2;
        white-space: nowrap;
    }

    .logo-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
        min-width: 0;
    }

    .logo-subtitle {
        font-size: 0.95rem;
        color: #64748b;
        font-weight: 400;
        white-space: nowrap;
        display: none;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    @media (min-width: 640px) {
        .logo-subtitle {
            display: block;
        }
    }

    .nav-desktop {
        display: none;
        gap: 0.25rem;
        justify-content: flex-end;
        align-items: center;
        flex: 1;
        min-width: 0;
    }

    @media (min-width: 1024px) {
        .nav-desktop {
            display: flex;
        }
    }

    .nav-link-wrapper {
        flex-shrink: 0;
    }

    .nav-link {
        padding: 0.5rem 1rem;
        font-size: 0.95rem;
        font-weight: 500;
        color: #374151;
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 40px;
    }

    .nav-link:hover {
        color: #0066cc;
        background: rgba(0, 102, 204, 0.08);
    }

    .nav-link.active {
        color: #0066cc;
        background: rgba(0, 102, 204, 0.08);
        font-weight: 600;
    }

    .more-dropdown-container {
        position: relative;
        flex-shrink: 0;
    }

    .more-trigger {
        gap: 0.25rem;
        cursor: pointer;
        border: none;
        background: none;
        width: auto;
    }

    .chevron {
        width: 16px;
        height: 16px;
        transition: transform 0.2s ease;
    }

    .rotate-180 {
        transform: rotate(180deg);
    }

    .more-dropdown-menu {
        position: absolute;
        top: calc(100% + 0.5rem);
        right: 0;
        background: white;
        border: 1px solid rgba(0, 102, 204, 0.1);
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 0.5rem;
        min-width: 160px;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .more-dropdown-item {
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        color: #475569;
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .more-dropdown-item:hover {
        background: rgba(0, 102, 204, 0.05);
        color: #0066cc;
    }

    .more-dropdown-item.active {
        background: rgba(0, 102, 204, 0.08);
        color: #0066cc;
        font-weight: 600;
    }

    [x-cloak] {
        display: none !important;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        justify-content: flex-end;
        flex: 0 0 auto;
    }

    .lang-switch {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 0.75rem;
        font-size: 0.9375rem;
        font-weight: 600;
        color: #0066cc;
        background: rgba(0, 102, 204, 0.1);
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.2s ease;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .lang-switch:hover {
        background: rgba(0, 102, 204, 0.2);
    }

    .mobile-menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        background: none;
        border: none;
        cursor: pointer;
        color: #374151;
    }

    @media (min-width: 1024px) {
        .mobile-menu-btn {
            display: none;
        }
    }

    .menu-icon {
        width: 24px;
        height: 24px;
    }

    .nav-mobile {
        display: flex;
        flex-direction: column;
        padding: 1rem;
        background: white;
        border-top: 1px solid rgba(0, 102, 204, 0.1);
    }

    @media (min-width: 1024px) {
        .nav-mobile {
            display: none !important;
        }
    }

    .nav-link-mobile {
        padding: 0.75rem 1rem;
        font-size: 1rem;
        font-weight: 500;
        color: #374151;
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .nav-link-mobile:hover {
        color: #0066cc;
        background: rgba(0, 102, 204, 0.08);
    }

    .nav-link-mobile.active {
        color: #0066cc;
        background: rgba(0, 102, 204, 0.08);
        font-weight: 600;
        border-left: 3px solid #0066cc;
    }
</style>
